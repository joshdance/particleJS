<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
	<meta name="viewport" content="width=device-width; initial-scale=1.0">
	<meta name="description" content="">
	<meta name="author" content="(C) Epistemex">

	<title>Proof-of-concept ParticleJS</title>

	<style>
		body {
			background:#333;
			color:#ccc;
			font:14px sans-serif;
			}

		.options{
			float:right;
			width:500px;
			}

		label {
			display:inline-block;
			width:100px;
			}
		output {
			text-align: right;
			display:inline-block;
			width:50px;
			}
	</style>

</head>
<body>

	<div id="container">
		<header>
			<h1>ParticleJS testbench</h1>
		</header>

		<div id="main">
			<canvas id="canvas" width="512" height="256" style="border:1px solid #000;background:#111"></canvas>

			<div class="options">
				<div>
					<label for="rngLife">Life (s)</label>
					<input id="rngLife" type="range" min="5" max="200" value="30">
					<output id="outLife">3</output>
				</div>

				<div>
					<label for="rngRate">Birth-rate</label>
					<input id="rngRate" type="range" min="1" max="2000" value="400">
					<output id="outRate">400</output>
				</div>

				<div>
					<label for="rngVel">Velocity</label>
					<input id="rngVel" type="range" min="0" max="1000" value="300">
					<output id="outVel">300</output>
				</div>

				<div>
					<label for="rngSize">Size</label>
					<input id="rngSize" type="range" min="1" max="200" value="100">
					<output id="outSize">100</output>
				</div>

				<div>
					<label for="rngFeather">Feather</label>
					<input id="rngFeather" type="range" min="0" max="50" value="36">
					<output id="outFeather">36</output>
				</div>

				<div>
					<label for="rngOpacity">Opacity</label>
					<input id="rngOpacity" type="range" min="0" max="1000" value="20">
					<output id="outOpacity">0.02</output>
				</div>

				<div>
					<label for="rngSpread">Spread</label>
					<input id="rngSpread" type="range" min="0" max="359" value="359">
					<output id="outSpread">359</output>
				</div>

				<div>
					<label for="rngSpreadA">Spread offset</label>
					<input id="rngSpreadA" type="range" min="0" max="359" value="0">
					<output id="outSpreadA">0</output>
				</div>

				<div>
					<label for="rngWindX">Wind X</label>
					<input id="rngWindX" type="range" min="-50" max="50" value="20">
					<output id="outWindX">0.2</output>
				</div>

				<div>
					<label for="rngWindY">Wind Y</label>
					<input id="rngWindY" type="range" min="-30" max="30" value="10">
					<output id="outWindY">0.1</output>
				</div>

				<div>
					<label for="rngGravY">Gravity Y</label>
					<input id="rngGravY" type="range" min="-20" max="20" value="4">
					<output id="outGravY">0.04</output>
				</div>

				<div>
					<label for="rngMagnet">Magnet force</label>
					<input id="rngMagnet" type="range" min="-20" max="20" value="0">
					<output id="outMagnet">0</output>
				</div>

				<div>
					<label for="rngMagnetR">Magnet radius</label>
					<input id="rngMagnetR" type="range" min="1" max="400" value="100">
					<output id="outMagnetR">100</output>
				</div>

				<div>
					<hr>
					<input id="chkShoot" type="checkbox">
					<label for="chkShoot">Click to spray</label>
				</div>

				<div>
					<input id="chkLock" type="checkbox">
					<label for="chkLock">Click to lock</label>
				</div>

			</div>
		</div>

		<footer>

		</footer>
	</div> 	<!-- container -->

<script src="../src/particle.core.js"></script>
<script src="../src/particle.scene.js"></script>
<script src="../src/particle.emitter2D.js"></script>
<script src="../src/particle.particle.js"></script>
<script src="../src/particle.physics.js"></script>
<script src="../src/particle.renderer.canvas.js"></script>
<script src="../src/particle.gradient.js"></script>

<script>

	// create scene
	var scene,
	    emitter,
	    renderer,
	    gradient,

		canvas = document.getElementById('canvas'),

		cnt = 0,
		toggle = false,
		mx = 100,
		my = 400,
		shoot = false,
		lock = false,
		isDown = false,
		brate = 400;

	// create scene
	scene = new ParticleJS.Scene({
		width: 800,
		height: 560,
		frameBound: false,
		FPS: 30                 // only if frame bound
	});

	// create gradient for emitter
	gradient = new ParticleJS.Gradient();

	gradient.addStop(0   , 'rgb(248, 252, 238)')
			.addStop(0.16, 'rgb(239, 230, 120)')
			.addStop(0.20, 'rgb(235, 123, 37)')
			.addStop(0.22, 'rgb(196, 54, 0)')
			.addStop(0.28, 'rgb(78, 21, 2)')
			.addStop(0.50, '#333')
			.addStop(1   , '#111');

	// create canvas renderer instance
	renderer = new ParticleJS.CanvasRenderer(canvas);

	// create an emitter for scene using above renderer
	emitter = new ParticleJS.Emitter2D({
		birthRate     : brate,      // particles per frame
		velocity      : 300,        // speed each particle is thrown at its direction
		randomVelocity: 60,         // variation in % between full and full - %
		life          : 3,          // life in seconds
		spread        : 360,        // angle of spread
		spreadAngle   : 0,          // if spread is not 360, angle offset to spread from
		x             : 400,        // emitter center
		y             : 200,
		size          : 100,        // global (max) diameter in pixels of each particle
		randomSize    : 60,         // size variation in %
		feather       : 36,         // feather in number of pixels
		randomFeather : 0,
		gradient      : gradient,   // optional gradient (overrides color below)
		r             : 150,        // base color
		g             : 190,
		b             : 250,
		opacity       : 0.16,       // global opacity, overridden by variation and ramp (opacity over life)
		randomOpacity : 0,
		renderer      : renderer,   // use this renderer (mandatory)
		preRender     : true        // call pre-render (clears canvas)
	});

	// add emitter to scene
	scene.addEmitter(emitter);

	// adjust some physics parameters
	emitter.physics.gravityY = -0.04;
	emitter.physics.windX = 0.2;
	emitter.physics.windY = 0.1;
	emitter.physics.airResistance = 0.2;

	// optional over-life arrays
	emitter.sizeOverLife = new Float32Array([0.5, 0.6, 0.7, 0.9, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]);
	emitter.opacityOverLife = new Float32Array([1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0.9, 0.8, 0.7, 0.6, 0.5, 0.4, 0.3, 0.25, 0.01]);
	emitter.featherOverLife = new Float32Array([1]); //new Float32Array([0.01, 0.25, 0.5, 0.75, 0.8, 0.9]);

	function getXY(e) {
		var r = canvas.getBoundingClientRect();
		return {
			x: e.clientX - r.left,
			y: e.clientY - r.top
		}
	}

	// move emitter with mouse position
	window.onmousemove = function(e) {
		if (!lock || isDown) {
			var p = getXY(e);
			mx = p.x;
			my = p.y;
		}
	};

	/*
		Options
	*/

	addEv('rngLife', 'change', function() {
		var v = this.value * 0.1;
		scene.emitters[0].life(v);
		document.getElementById('outLife').innerHTML = v.toFixed(1);
	});

	addEv('rngRate', 'change', function() {
		brate = this.value;
		if (!shoot) scene.emitters[0].birthRate(brate);
		document.getElementById('outRate').innerHTML = brate;
	});

	addEv('rngVel', 'change', function() {
		var v = this.value;
		scene.emitters[0].velocity(v);
		document.getElementById('outVel').innerHTML = v;
	});

	addEv('rngSize', 'change', function() {
		var v = this.value;
		scene.emitters[0].size(v);
		document.getElementById('outSize').innerHTML = v;
	});

	addEv('rngOpacity', 'change', function() {
		var v = this.value * 0.001;
		scene.emitters[0].opacity(v);
		document.getElementById('outOpacity').innerHTML = v.toFixed(3);
	});

	addEv('rngFeather', 'change', function() {
		var v = this.value;
		scene.emitters[0].feather(v);
		document.getElementById('outFeather').innerHTML = v;
	});

	addEv('rngSpread', 'change', function() {
		var v = this.value;
		scene.emitters[0].spread(v);
		document.getElementById('outSpread').innerHTML = v;
	});

	addEv('rngSpreadA', 'change', function() {
		var v = this.value;
		scene.emitters[0].spreadAngle(v);
		document.getElementById('outSpreadA').innerHTML = v;
	});

	addEv('rngWindX', 'change', function() {
		var v = this.value * 0.1;
		scene.emitters[0].physics.windX = v;
		document.getElementById('outWindX').innerHTML = v.toFixed(1);
	});

	addEv('rngWindY', 'change', function() {
		var v = this.value * 0.1;
		scene.emitters[0].physics.windY = v;
		document.getElementById('outWindY').innerHTML = v.toFixed(1);
	});

	addEv('rngGravY', 'change', function() {
		var v = this.value * 0.01;
		scene.emitters[0].physics.gravityY = v;
		document.getElementById('outGravY').innerHTML = v.toFixed(3);
	});

	addEv('rngMagnet', 'change', function() {
		var v = this.value * 0.1;
		scene.emitters[0].physics.magnetForce = v;
		document.getElementById('outMagnet').innerHTML = v.toFixed(1);
	});

	addEv('rngMagnetR', 'change', function() {
		var v = this.value;
		scene.emitters[0].physics.magnetRadius = v;
		scene.emitters[0].physics.magnetRadiusSqr = v*v;
		document.getElementById('outMagnetR').innerHTML = v;
	});

	addEv('chkLock', 'change', function() {
		lock = !!this.checked;
	});

	// allow "shooting" (mouse down = birth rate, up = none)
	addEv('chkShoot', 'change', function() {

		shoot = !!this.checked;

		if (shoot) {
			scene.emitters[0].birthRate(0);
		}
		else {
			scene.emitters[0].birthRate(brate);
		}
	});

	// for shooting
	canvas.addEventListener('mousedown', function(e) {
		scene.emitters[0].birthRate(brate);
		isDown = true;
		var p = getXY(e);
		mx = p.x;
		my = p.y;
	}, false);

	window.addEventListener('mouseup', function() {
		if (shoot) scene.emitters[0].birthRate(0);
		isDown = false;
	}, false);

	// main loop
	(function loop() {

		/*toggle = !toggle;       // run at 30 FPS

		if (toggle) {
			requestAnimationFrame(loop);
			return;
		}*/

		scene.render();

		scene.emitters[0].x = mx;
		scene.emitters[0].y = my;

		//cnt++;
		//if (cnt < 2000)
		requestAnimationFrame(loop);
	})();

	function getEl(id) {
		return document.getElementById(id);
	}

	function addEv(id, event, func) {
		getEl(id).addEventListener(event, func, false);
	}
</script>
</body>
</html>
